#Hogyan gyártsunk Egységtesztelős programot Yii-vel (Test Driven Development)

http://code.google.com/images/code_sm.png

= Introduction =

_"Ismeret az nem cselekedet, csakis cselekedet a cselekedet"_ - tdc10

= Táblák =

{{{
++++++++++++++++++++++++++
+ urls                   +
++++++++++++++++++++++++++
+ id INT (auto_increment)+
+ url TEXT               +
+ slug VARCHAR(50)       +
+ created INT            +
++++++++++++++++++++++++++
}}}

*SQLite3*
{{{
CREATE TABLE urls (created INTEGER, id INTEGER PRIMARY KEY AUTOINCREMENT, slug varchar(50), url TEXT);
}}}

_protected/config/main.php_
{{{
...
  'connectionString' => 'sqlite:'.dirname(__FILE__).'/../data/rovidke.db',
...
}}}

(iras jog!)
{{{
CDbCommand failed to execute the SQL statement: SQLSTATE[HY000]: General error: 8 attempt to write a readonly database
}}}

{{{
./protected/yiic shell
Yii Interactive Tool v1.1 (based on Yii v1.1.3)
Please type 'help' for help. Type 'exit' to quit.
>> _
}}}

{{{
>> model Url urls
   generate models/Url.php
   generate fixtures/urls.php
   generate unit/UrlTest.php

The following model classes are successfully generated:
    Url

If you have a 'db' database connection, you can test these models now with:
    $model=Url::model()->find();
    print_r($model);
>>
}}}

_protected/tests/_

{{{
$phpunit unit
...
There was 1 error:

1) testCreate(UrlTest)
CDbException: The table "urls" for active record class "Url" cannot be found in the database.
...
}}}

_protected/config/test.php_
{{{
...
 'connectionString'=>'sqlite:' . dirname(__FILE__).'/../rovidke_test.db',
...
}}}


_protected/tests/_
{{{
$phpunit unit
PHPUnit 3.3.16 by Sebastian Bergmann.

.

Time: 0 seconds

OK (1 test, 0 assertions)
}}}

_protected/tests/unit/UrlTest.php_
{{{
...
    public function testTrue()
    {
        $this->assertTrue( false );
    }

    public function testTrue2()
    {
        $this->assertTrue( true );
    }
...
}}}

_protected/tests/_
{{{
$phpunit unit

PHPUnit 3.3.16 by Sebastian Bergmann.

F.

Time: 0 seconds

There was 1 failure:

1) testTrue(UrlTest)
Failed asserting that <boolean:false> is true.
/var/www/rovidke/protected/tests/unit/UrlTest.php:18

FAILURES!
Tests: 2, Assertions: 2, Failures: 1.

}}}

= Fixtures - Minta Adat =

{{{
return array(
	'sample1'=>array(
		'created' => '1234567890',
		'slug' => 'AA',
		'url' => 'http://weblabor.hu',
	),
	'sample2'=>array(
		'created' => '1234567890',
		'slug' => 'AB',
		'url' => 'http://google.com',
	),
);
}}}

_protected/tests_
{{{
$phpunit unit/
...
  Failed asserting that <integer:2> matches expected value <integer:1>.
...
}}}

{{{
...
    public function testCountAll()
    {
        $urls_count = sizeof(Url::model()->findAll());
        $this->assertEquals( 2, $urls_count );
    }
...
}}}

_protected/tests/unit/UrlTest.php_
{{{
...
    public function testActionView()
    {
        $url = Url::model()->findByAttributes( array( 'id' => 1 ) );

        $this->assertTrue( $url instanceof Url );
        $this->assertEquals( $url->url, 'http://altavizsla.hu' );
    }
...
}}}

_protected/tests/_
{{{
$phpunit unit
...
There was 1 failure:

expected string <http://weblabor.hu>
difference      <       xxxxxxxxxxx??>
got string      <http://altavizsla.hu>
...
}}}

_protected/tests/unit/UrlTest.php_
{{{
...
  $url = Url::model()->findByAttributes( array( 'id' => 2 ) );
...
}}}

_protected/tests/unit/UrlTest.php_
{{{
...
    public function testUrlRequired()
    {
        $this->assertTrue( Url::model()->isAttributeRequired( 'url' ) );
    }
...
}}}

_protected/models/Url.php_
{{{
...
    return array(
       ...
       array( 'url', 'required' ),
       ...
    );
...
}}}

_protected/tests/unit/UrlTest.php_
{{{
...
    public function testSlugRequired()
    {
        $this->assertTrue( Url::model()->isAttributeRequired( 'slug' ) );
    }
...
}}}

_protected/models/Url.php_
{{{
...
    return array(
       ...
       array( 'url,slug', 'required' ),
       ...
    );
...
}}}



_protected/tests/unit/UrlTest.php_
{{{
...
    public function testCreateUrl()
    {
        $url = new Url();
        $url->setAttribute( 'url', 'http://altavista.hu' );
        $this->assertTrue( $url->save(), 'URL tarolas tesztelese' );
        $this->assertEquals( $url->slug, 'AA' );
    }
...
}}}

_protected/models/Url.php_
{{{
    public function beforeValidate()
    {
        $this->shortened = $this->createSlug();
        return parent::beforeValidate();
    }

    public function createSlug()
    {
       return 'AA'; 
    }
}}}

{{{
    public function createSlug()
    {
        $slug = Url::model()->find( array( 'order' => 'slug DESC' ) )->slug;

        if( ! $slug )
        {
            $slug = 'AA';
        }
        else
        {
            ++$slug;
        }

        return $slug; 
    }
}}}

_protected/tests/_
{{{
$phpunit unit/

...
Failed asserting that two strings are equal.
expected string <AC>
difference      < x>
got string      <AA>
...
}}}

_protected/tests/unit/UrlTest.php_
{{{
...
    public function testCreateUrl()
    {
        $url = new Url();
        $url->setAttribute( 'url', 'http://altavista.hu' );
        $this->assertTrue( $url->save(), 'URL tarolas tesztelese' );
        $this->assertEquals( $url->slug, 'AC' );
    }
...
}}}

_protected/models/Url.php_
{{{
...
    public function createSlug()
    {
        $slug = Url::model()->find( array( 'order' => 'slug DESC' ) )->slug;
        return $slug ? ++$slug : 'AA';
    }
...
}}}

_protected/yiic shell_
{{{
>> crud Url
   generate UrlController.php
   generate UrlTest.php
      mkdir /var/www/rovidke/protected/views/url
   generate create.php
   generate update.php
   generate index.php
   generate view.php
   generate admin.php
   generate _form.php
   generate _view.php
   generate _search.php

}}}

_protected/config/main.php_
{{{
...
    'defaultController'    => 'url/create',
...
}}}

_protected/controllers/UrlController.php
{{{
...
			array('allow',  // allow all users to perform 'index' and 'view' actions
				'actions'=>array('index','view', 'create'),
				'users'=>array('*'),
			),
			array('allow', // allow authenticated user to perform 'create' and 'update' actions
				'actions'=>array('update'),
				'users'=>array('@'),
			),
...
}}}

_protected/views/url/_form.php_
{{{
...
    <?php /*
	<div class="row">
		<?php echo $form->labelEx($model,'created'); ?>
		<?php echo $form->textField($model,'created'); ?>
		<?php echo $form->error($model,'created'); ?>
	</div>

	<div class="row">
		<?php echo $form->labelEx($model,'shortened'); ?>
		<?php echo $form->textField($model,'shortened',array('size'=>50,'maxlength'=>50)); ?>
		<?php echo $form->error($model,'shortened'); ?>
	</div>
    */ 
    ?>

	<div class="row">
		<?php echo $form->labelEx($model,'url'); ?>
		<?php echo $form->textField($model,'url', array( 'size' => 50 )); ?>
		<?php echo $form->error($model,'url'); ?>
	</div>
...
}}}

_protected/views/url/view.php_
{{{
...
<?php 
    echo 
        CHtml::link( 
            'http://' . $_SERVER['SERVER_NAME'] . '/' . $model->slug, 
            $this->createUrl( '/' . $model->slug ) 
        );
?>
...
<?php 
/*
$this->widget('zii.widgets.CDetailView', array(
	'data'=>$model,
	'attributes'=>array(
		'created',
		'id',
		'slug',
		'updated',
		'url',
	),
)); 
*/
?>
}}}

_protected/config/main.php_
{{{
...
        'urlManager'=>array(
             'urlFormat'=>'path',
             'showScriptName' => false,
             'rules'=>array(
                 '/<slug:[A-Z]+>' => 'url/redirect',
                 '<controller:\w+>/<id:\d+>'=>'<controller>/view',
                 '<controller:\w+>/<action:\w+>/<id:\d+>'=>'<controller>/<act    ion>',
                 '<controller:\w+>/<action:\w+>'=>'<controller>/<action>',
             ),
         ),
...
}}}

Add your content here.


= Details =

Add your content here.  Format your content with:
  * Text in *bold* or _italic_
  * Headings, paragraphs, and lists
  * Automatic links to other wiki pages